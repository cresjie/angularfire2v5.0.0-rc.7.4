{"version":3,"file":"fromRef.js","sourceRoot":"","sources":["../../../../src/database/observable/fromRef.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,UAAU,EAAE,MAAM,iBAAiB,CAAC;AAE7C,OAAO,uBAAuB,CAAC;AAC/B,OAAO,yBAAyB,CAAC;AACjC,OAAO,yBAAyB,CAAC;AAYjC,MAAM,kBAAkB,GAAkB,EAAE,KAAkB,EAAE,UAAiB;IAAjB,2BAAA,EAAA,iBAAiB;IAC/E,MAAM,CAAC,IAAI,UAAU,CAAkB,UAAA,UAAU;QAC/C,IAAM,EAAE,GAAG,GAAG,CAAC,UAAU,CAAC,CAAC,KAAK,EAAE,UAAC,QAAQ,EAAE,OAAO;YAClD,UAAU,CAAC,IAAI,CAAC,EAAE,QAAQ,UAAA,EAAE,OAAO,SAAA,EAAE,CAAC,CAAC;YACvC,EAAE,CAAC,CAAC,UAAU,IAAI,MAAM,CAAC,CAAC,CAAC;gBAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;aAAE;SACrD,EAAE,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;QACtC,EAAE,CAAC,CAAC,UAAU,IAAI,IAAI,CAAC,CAAC,CAAC;YACvB,MAAM,CAAC,EAAE,WAAW,gBAAK,GAAG,CAAC,GAAG,CAAC,KAAK,EAAE,EAAE,CAAC,CAAA,EAAC,EAAE,CAAC;SAChD;QAAC,IAAI,CAAC,CAAC;YACN,MAAM,CAAC,EAAE,WAAW,iBAAM,EAAE,CAAC;SAC9B;KACF,CAAC;SACD,GAAG,CAAC,UAAC,OAAwB;QACpB,IAAA,2BAAQ,EAAE,yBAAO,CAAa;QACtC,IAAI,GAAG,GAAkB,IAAI,CAAC;QAC9B,EAAE,CAAC,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YAAC,GAAG,GAAG,QAAQ,CAAC,GAAG,CAAC;SAAE;QAC9C,MAAM,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO,SAAA,EAAE,GAAG,KAAA,EAAE,CAAC;KACzD,CAAC;SAID,KAAK,CAAC,CAAC,CAAC;SACR,KAAK,EAAE,CAAC;CACV","sourcesContent":["import { DatabaseQuery, DatabaseSnapshot, ListenEvent, AngularFireAction } from '../interfaces';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { FirebaseZoneScheduler } from 'angularfire2';\r\nimport 'rxjs/add/operator/map';\r\nimport 'rxjs/add/operator/delay';\r\nimport 'rxjs/add/operator/share';\r\n\r\ninterface SnapshotPrevKey {\r\n  snapshot: DatabaseSnapshot;\r\n  prevKey: string | null | undefined;\r\n}\r\n\r\n/**\r\n * Create an observable from a Database Reference or Database Query.\r\n * @param ref Database Reference\r\n * @param event Listen event type ('value', 'added', 'changed', 'removed', 'moved')\r\n */\r\nexport function fromRef(ref: DatabaseQuery, event: ListenEvent, listenType = 'on'): Observable<AngularFireAction<DatabaseSnapshot>> {\r\n  return new Observable<SnapshotPrevKey>(subscriber => {\r\n    const fn = ref[listenType](event, (snapshot, prevKey) => {\r\n      subscriber.next({ snapshot, prevKey });\r\n      if (listenType == 'once') { subscriber.complete(); }\r\n    }, subscriber.error.bind(subscriber));\r\n    if (listenType == 'on') {\r\n      return { unsubscribe() { ref.off(event, fn)} };\r\n    } else {\r\n      return { unsubscribe() { } };\r\n    }\r\n  })\r\n  .map((payload: SnapshotPrevKey) =>  {\r\n    const { snapshot, prevKey } = payload;\r\n    let key: string | null = null;\r\n    if (snapshot.exists()) { key = snapshot.key; }\r\n    return { type: event, payload: snapshot, prevKey, key };\r\n  })\r\n  // Ensures subscribe on observable is async. This handles\r\n  // a quirk in the SDK where on/once callbacks can happen\r\n  // synchronously.\r\n  .delay(0)\r\n  .share();\r\n}\r\n"]}